<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Vector Ray Trace: Cassegrain + Toroidal M3 â€” v3.5</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        :root {
            --bg:#121212; --panel:#1e1e1e; --text:#e0e0e0;
            --accent:#00bcd4; --accent-h:#00acc1;
            --err:#cf6679; --ok:#03dac6; --warn:#ffb74d;
            --border:#333; --input-bg:#2d2d2d; --sidebar-w:340px;
            --zemax:#7c4dff; --zemax-h:#651fff;
        }
        *,*::before,*::after{box-sizing:border-box;}
        html{height:100%;}
        body{font-family:'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
             background:var(--bg);color:var(--text);margin:0;padding:0;
             display:flex;height:100%;overflow:hidden;}
        ::-webkit-scrollbar{width:6px;height:6px;}
        ::-webkit-scrollbar-track{background:var(--bg);}
        ::-webkit-scrollbar-thumb{background:#444;border-radius:3px;}

        /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sidebar{width:var(--sidebar-w);background:var(--panel);
                 border-right:1px solid var(--border);display:flex;
                 flex-direction:column;padding:18px 16px;overflow-y:auto;
                 flex-shrink:0;box-shadow:4px 0 15px rgba(0,0,0,.5);z-index:20;}
        .mobile-toggle{display:none;width:100%;background:var(--panel);
                       border:none;border-bottom:1px solid var(--border);
                       color:var(--accent);font-size:.85rem;font-weight:700;
                       letter-spacing:.5px;padding:12px 16px;text-align:left;
                       cursor:pointer;position:sticky;top:0;z-index:30;flex-shrink:0;}
        .mobile-toggle svg{float:right;transition:transform .25s;}
        .mobile-toggle.open svg{transform:rotate(180deg);}

        /* â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .main-content{flex:1;display:flex;flex-direction:column;
                      background:#050505;min-width:0;overflow:hidden;}
        #plotDiv{flex:1;min-height:0;}
        #spotDiv{height:300px;flex-shrink:0;border-top:1px solid var(--border);}

        /* â”€â”€ Typography â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        h1{margin:0 0 2px;font-size:1.15rem;color:var(--accent);letter-spacing:.5px;}
        .version-tag{font-size:.62rem;color:#555;font-family:'Consolas',monospace;
                     margin-bottom:12px;letter-spacing:.5px;}
        h2{margin:0 0 16px;font-size:.75rem;opacity:.55;font-weight:normal;text-transform:uppercase;}
        .section-header{font-size:.72rem;font-weight:700;color:#777;margin:14px 0 7px;
                        text-transform:uppercase;letter-spacing:1px;
                        border-bottom:1px solid #2a2a2a;padding-bottom:3px;}
        .input-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
        .input-group{margin-bottom:7px;}
        .input-group label{display:block;font-size:.72rem;margin-bottom:3px;color:#999;}
        .input-group input[type="number"],
        .input-group input[type="range"]{
            width:100%;background:var(--input-bg);border:1px solid #444;
            color:#fff;padding:7px 8px;border-radius:4px;
            font-family:'Consolas',monospace;font-size:16px;
            transition:border-color .2s,background .2s;-webkit-appearance:none;}
        .input-group input[type="number"]:focus{outline:none;border-color:var(--accent);background:#383838;}
        .input-group input[type="range"]{padding:0;height:36px;background:transparent;
                                         border:none;cursor:pointer;touch-action:manipulation;}
        .input-group input[type="range"]::-webkit-slider-runnable-track{background:#444;height:4px;border-radius:2px;}
        .input-group input[type="range"]::-webkit-slider-thumb{-webkit-appearance:none;
            width:20px;height:20px;border-radius:50%;background:var(--accent);margin-top:-8px;}

        /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn-row{display:flex;gap:8px;margin-top:16px;}
        button.run-btn{flex:2;padding:14px;background:var(--accent);color:#000;
                       border:none;border-radius:5px;font-weight:700;font-size:.85rem;
                       cursor:pointer;text-transform:uppercase;letter-spacing:1px;
                       min-height:48px;transition:all .2s;box-shadow:0 4px 8px rgba(0,0,0,.4);
                       touch-action:manipulation;}
        button.run-btn:hover{background:var(--accent-h);transform:translateY(-1px);}
        button.run-btn:active{transform:translateY(1px);}
        button.zemax-btn{flex:1;padding:14px;background:var(--zemax);color:#fff;
                         border:none;border-radius:5px;font-weight:700;font-size:.78rem;
                         cursor:pointer;text-transform:uppercase;letter-spacing:.8px;
                         min-height:48px;transition:all .2s;box-shadow:0 4px 8px rgba(0,0,0,.4);
                         touch-action:manipulation;line-height:1.2;}
        button.zemax-btn:hover{background:var(--zemax-h);transform:translateY(-1px);}
        button.zemax-btn:active{transform:translateY(1px);}
        button.zemax-btn:disabled{background:#3a3a3a;color:#666;cursor:not-allowed;transform:none;}

        /* â”€â”€ Results â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .results-panel{margin-top:16px;background:#252525;padding:13px;border-radius:5px;
                       border-left:3px solid var(--accent);font-family:'Consolas',monospace;font-size:.82rem;}
        .metric-row{display:flex;justify-content:space-between;margin-bottom:4px;}
        .metric-label{color:#777;} .metric-val{color:#fff;font-weight:700;}
        .val-good{color:var(--ok);} .val-bad{color:var(--err);}
        .val-info{color:var(--accent);} .val-warn{color:var(--warn);}
        .sub-header{font-size:.68rem;color:#555;text-transform:uppercase;letter-spacing:1px;
                    margin:9px 0 4px;border-top:1px solid #2a2a2a;padding-top:7px;}
        .tooltip{font-size:.67rem;color:#4a4a4a;margin-top:6px;font-style:italic;line-height:1.4;}
        .status-bar{padding:4px 10px;background:#111;border-top:1px solid var(--border);
                    font-size:.7rem;color:#555;display:flex;justify-content:space-between;flex-shrink:0;}

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           ZEMAX MODAL
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-backdrop{
            display:none;position:fixed;inset:0;
            background:rgba(0,0,0,.75);z-index:1000;
            align-items:center;justify-content:center;
            padding:16px;}
        .modal-backdrop.open{display:flex;}
        .modal{
            background:#1a1a1a;border:1px solid var(--zemax);
            border-radius:8px;width:100%;max-width:780px;
            max-height:90vh;display:flex;flex-direction:column;
            box-shadow:0 8px 40px rgba(124,77,255,.3);}
        .modal-header{
            display:flex;align-items:center;justify-content:space-between;
            padding:14px 20px;border-bottom:1px solid #333;flex-shrink:0;}
        .modal-header h3{margin:0;font-size:1rem;color:var(--zemax);letter-spacing:.5px;}
        .modal-header .close-btn{
            background:none;border:none;color:#666;font-size:1.4rem;
            cursor:pointer;padding:0 4px;line-height:1;transition:color .2s;}
        .modal-header .close-btn:hover{color:#fff;}

        /* Tabs */
        .tab-bar{display:flex;gap:0;border-bottom:1px solid #333;flex-shrink:0;}
        .tab-btn{
            padding:10px 20px;background:none;border:none;border-bottom:2px solid transparent;
            color:#666;font-size:.8rem;font-weight:600;text-transform:uppercase;letter-spacing:.8px;
            cursor:pointer;transition:all .15s;margin-bottom:-1px;}
        .tab-btn:hover{color:#aaa;}
        .tab-btn.active{color:var(--zemax);border-bottom-color:var(--zemax);}

        /* Tab content */
        .tab-content{flex:1;overflow-y:auto;padding:20px;}
        .tab-pane{display:none;}
        .tab-pane.active{display:block;}

        /* LDE table */
        .lde-block{
            font-family:'Consolas','Courier New',monospace;font-size:.78rem;
            background:#0d0d0d;border:1px solid #2a2a2a;border-radius:4px;
            padding:14px;overflow-x:auto;white-space:pre;line-height:1.55;
            color:#ccc;}
        .lde-head{color:var(--zemax);}
        .lde-sep{color:#444;}
        .lde-mirror{color:#00bcd4;}
        .lde-cb{color:#ffb74d;}
        .lde-toroid{color:var(--zemax);}
        .lde-img{color:#888;}

        /* Steps */
        .steps-block{font-size:.85rem;line-height:1.65;color:#ccc;}
        .step{margin-bottom:18px;}
        .step-num{display:inline-block;width:22px;height:22px;border-radius:50%;
                  background:var(--zemax);color:#fff;font-size:.7rem;font-weight:700;
                  text-align:center;line-height:22px;margin-right:8px;flex-shrink:0;}
        .step-title{color:#fff;font-weight:600;font-size:.88rem;}
        .step-body{margin-top:6px;padding-left:30px;color:#aaa;}
        .param-box{
            background:#0d0d0d;border:1px solid #2a2a2a;border-left:3px solid var(--zemax);
            border-radius:3px;padding:10px 14px;margin-top:8px;
            font-family:'Consolas',monospace;font-size:.8rem;line-height:1.7;color:#ccc;}
        .param-key{color:#ffb74d;}
        .param-val{color:var(--ok);}
        .warn-box{
            background:#1a1200;border:1px solid #664d00;border-radius:4px;
            padding:8px 12px;margin-top:8px;font-size:.78rem;color:#ffb74d;}

        /* Copy buttons */
        .copy-bar{display:flex;justify-content:flex-end;margin-top:10px;}
        .copy-btn{
            background:#252525;border:1px solid #444;color:#aaa;
            padding:6px 14px;border-radius:4px;font-size:.75rem;cursor:pointer;
            transition:all .15s;letter-spacing:.5px;}
        .copy-btn:hover{background:#333;color:#fff;border-color:#666;}
        .copy-btn.copied{background:#1a3a2a;border-color:var(--ok);color:var(--ok);}

        /* System info box at top of modal */
        .sysinfo{
            display:flex;flex-wrap:wrap;gap:8px;
            padding:12px 20px;border-bottom:1px solid #2a2a2a;
            background:#141414;flex-shrink:0;}
        .sysinfo-chip{
            background:#252525;border:1px solid #333;border-radius:20px;
            padding:4px 12px;font-size:.75rem;font-family:'Consolas',monospace;}
        .sysinfo-chip span{color:var(--accent);font-weight:700;}

        /* â”€â”€ Mobile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        @media(max-width:900px){:root{--sidebar-w:280px;}#spotDiv{height:260px;}}
        @media(max-width:640px){
            body{flex-direction:column;height:auto;min-height:100%;overflow:hidden;overflow-y:auto;}
            .mobile-toggle{display:block;}
            .sidebar{width:100%;border-right:none;border-bottom:1px solid var(--border);
                     box-shadow:none;overflow:hidden;max-height:0;padding:0 16px;
                     transition:max-height .35s ease,padding .35s ease;}
            .sidebar.open{max-height:2000px;padding:16px;overflow-y:auto;}
            .main-content{overflow:visible;flex:none;}
            #plotDiv{flex:none;height:max(280px,70vw);}
            #spotDiv{height:520px;flex:none;}
            .input-group input[type="number"]{padding:10px 8px;}
            .modal{max-height:95vh;border-radius:6px;}
            .lde-block{font-size:.68rem;}
            .tab-btn{padding:8px 12px;font-size:.72rem;}
        }
        @media(max-width:380px){.input-grid{grid-template-columns:1fr;}}
        @supports(padding:max(0px)){
            .sidebar,.mobile-toggle{
                padding-left:max(16px,env(safe-area-inset-left));
                padding-right:max(16px,env(safe-area-inset-right));}
            .status-bar{padding-bottom:max(4px,env(safe-area-inset-bottom));}
        }
    </style>
</head>
<body>

<!-- Mobile toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button class="mobile-toggle" id="sidebarToggle"
        onclick="toggleSidebar()" aria-expanded="false" aria-controls="sidebar">
    â˜° &nbsp;Parameters
    <svg width="14" height="14" viewBox="0 0 14 14" fill="none">
        <polyline points="2,4 7,10 12,4" stroke="currentColor" stroke-width="2"
                  stroke-linecap="round" stroke-linejoin="round"/>
    </svg>
</button>

<!-- Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="sidebar" id="sidebar" role="complementary" aria-label="System parameters">
    <header>
        <h1>Cassegrain Optimiser</h1>
        <div class="version-tag">v3.5 Â· True Toroid Â· 2Ã—2 Newton Â· Zemax Export</div>
        <h2>3D Vector Ray Trace Engine</h2>
    </header>

    <div class="section-header">Primary Mirror (M1)</div>
    <div class="input-grid">
        <div class="input-group"><label for="m1_dia">Diameter (mm)</label>
            <input type="number" id="m1_dia" value="600" inputmode="decimal"></div>
        <div class="input-group"><label for="m1_roc">Radius (neg, mm)</label>
            <input type="number" id="m1_roc" value="-2447.7" inputmode="decimal"></div>
    </div>
    <div class="input-group"><label for="m1_k">Conic constant (k)</label>
        <input type="number" id="m1_k" value="-1" inputmode="decimal"></div>

    <div class="section-header">Secondary Mirror (M2)</div>
    <div class="input-grid">
        <div class="input-group"><label for="m2_roc">Radius (neg, mm)</label>
            <input type="number" id="m2_roc" value="-272.2" inputmode="decimal"></div>
        <div class="input-group"><label for="m2_k">Conic constant (k)</label>
            <input type="number" id="m2_k" value="-1.4336" inputmode="decimal"></div>
    </div>
    <div class="input-group"><label for="d1">Dist. from M1 (mm)</label>
        <input type="number" id="d1" value="1100" inputmode="decimal"></div>

    <div class="section-header">Fold Mirror (M3) â€” Toroid</div>
    <div class="input-grid">
        <div class="input-group"><label for="m3_back">Dist. behind M1 (mm)</label>
            <input type="number" id="m3_back" value="100" inputmode="decimal"></div>
        <div class="input-group"><label for="target_bfl">Target BFL (mm)</label>
            <input type="number" id="target_bfl" value="50" inputmode="decimal"></div>
    </div>

    <div class="section-header">Settings</div>
    <div class="input-grid">
        <div class="input-group"><label for="ray_density">Ray Density</label>
            <input type="range" id="ray_density" min="3" max="25" value="7"></div>
        <div class="input-group"><label for="ray_len">Ray Extension (mm)</label>
            <input type="range" id="ray_len" min="0" max="500" value="50" step="10"></div>
        <div class="input-group"><label for="det_diag">Detector Diagonal (mm)</label>
            <input type="number" id="det_diag" value="20" min="1" max="200" inputmode="decimal"></div>
        <div class="input-group"><label for="lambda_nm">Spot Î» (nm)</label>
            <input type="number" id="lambda_nm" value="550" min="300" max="1100" step="10" inputmode="decimal"></div>
    </div>

    <div class="btn-row">
        <button class="run-btn" onclick="runOptimization()">â–¶ Run Solver</button>
        <button class="zemax-btn" id="zemaxBtn" onclick="openZemax()" disabled
                title="Run solver first">
            â¬¡ Zemax<br>Export
        </button>
    </div>

    <div class="results-panel" id="results">
        <div style="text-align:center;color:#444;padding:8px 0;">Waiting for traceâ€¦</div>
    </div>
    <div class="tooltip">
        *2Ã—2 Newton solver Â· true toroidal sag.<br>
        â€ Footprints: filled 20-ring pupil, no margin.<br>
        â€¡Zemax export: live values from last solve.
    </div>
</div>

<!-- Main content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="main-content" role="main">
    <div id="plotDiv"></div>
    <div id="spotDiv"></div>
    <div class="status-bar">
        <span id="status-msg">System Ready</span>
        <span>v3.5</span>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ZEMAX MODAL
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div class="modal-backdrop" id="zemaxModal" role="dialog"
     aria-modal="true" aria-labelledby="modalTitle"
     onclick="handleBackdropClick(event)">
    <div class="modal">
        <div class="modal-header">
            <h3 id="modalTitle">â¬¡ &nbsp;Zemax OpticStudio 2025 â€” System Prescription</h3>
            <button class="close-btn" onclick="closeZemax()" aria-label="Close">âœ•</button>
        </div>

        <!-- System info chips -->
        <div class="sysinfo" id="modal-sysinfo"></div>

        <!-- Tabs -->
        <div class="tab-bar">
            <button class="tab-btn active" onclick="switchTab('lde',this)">LDE Prescription</button>
            <button class="tab-btn" onclick="switchTab('steps',this)">Step-by-Step Guide</button>
            <button class="tab-btn" onclick="switchTab('pitfalls',this)">âš  Pitfalls</button>
        </div>

        <!-- Tab: LDE Prescription -->
        <div class="tab-content">
            <div class="tab-pane active" id="tab-lde">
                <p style="font-size:.8rem;color:#666;margin:0 0 12px;">
                    Copy this table into the Zemax <strong>Lens Data Editor</strong>.
                    Surface 5 uses the <strong>Toroidal</strong> surface type â€”
                    enter R<sub>s</sub> in <em>Extra Data Editor â†’ Par 1</em>.
                </p>
                <div class="lde-block" id="lde-text"></div>
                <div class="copy-bar">
                    <button class="copy-btn" onclick="copySection('lde-text',this)">Copy LDE</button>
                </div>
            </div>

            <!-- Tab: Step-by-step -->
            <div class="tab-pane" id="tab-steps">
                <div class="steps-block" id="steps-text"></div>
                <div class="copy-bar">
                    <button class="copy-btn" onclick="copySection('steps-text',this)">Copy Steps</button>
                </div>
            </div>

            <!-- Tab: Pitfalls -->
            <div class="tab-pane" id="tab-pitfalls">
                <div class="steps-block" id="pitfalls-text"></div>
            </div>
        </div>
    </div>
</div>

<script>
/**
 * ============================================================
 * CASSEGRAIN + TOROIDAL M3 â€” v3.5  (2026-02-18)
 * ============================================================
 * v3.5 additions:
 *  [26] Zemax Export button (purple, right of Run Solver).
 *       Disabled until first solve completes.
 *  [27] Zemax modal with three tabs:
 *       Tab 1 â€” LDE Prescription: formatted fixed-width table
 *         with all 8 surfaces, colour-coded by type, plus
 *         Extra Data block for M3 toroidal parameters.
 *       Tab 2 â€” Step-by-Step Guide: 7 numbered steps with
 *         exact live values from the last solve.
 *       Tab 3 â€” Pitfalls: 5 critical warnings for correct
 *         Coordinate Break / toroidal radius sign setup.
 *  [28] generateZemaxReport(sol): builds all modal content
 *       from live solver output â€” updates on every solve.
 *  [29] copySection(): clipboard copy with visual feedback.
 *  [30] Keyboard Escape closes modal.
 * ============================================================
 */

const isMobile=()=>window.innerWidth<=640;
let _lastSol=null;  // stores last solve result for Zemax export [28]

// â”€â”€ Sidebar toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function toggleSidebar(){
    const sb=document.getElementById('sidebar'),btn=document.getElementById('sidebarToggle');
    const open=sb.classList.toggle('open');
    btn.classList.toggle('open',open);btn.setAttribute('aria-expanded',open);
    setTimeout(()=>{Plotly.Plots.resize('plotDiv');Plotly.Plots.resize('spotDiv');},370);
}

// â”€â”€ Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openZemax(){
    if(!_lastSol)return;
    generateZemaxReport(_lastSol);
    document.getElementById('zemaxModal').classList.add('open');
    document.body.style.overflow='hidden';
}
function closeZemax(){
    document.getElementById('zemaxModal').classList.remove('open');
    document.body.style.overflow='';
}
function handleBackdropClick(e){if(e.target===e.currentTarget)closeZemax();}
document.addEventListener('keydown',e=>{if(e.key==='Escape')closeZemax();});

function switchTab(name,btn){
    document.querySelectorAll('.tab-pane').forEach(p=>p.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+name).classList.add('active');
    btn.classList.add('active');
}

// [29] Copy to clipboard
function copySection(id,btn){
    const el=document.getElementById(id);
    const text=el.innerText||el.textContent;
    navigator.clipboard.writeText(text).then(()=>{
        btn.textContent='âœ“ Copied!';btn.classList.add('copied');
        setTimeout(()=>{btn.textContent=id==='lde-text'?'Copy LDE':'Copy Steps';
                        btn.classList.remove('copied');},2000);
    }).catch(()=>{
        const ta=document.createElement('textarea');
        ta.value=text;document.body.appendChild(ta);ta.select();
        document.execCommand('copy');document.body.removeChild(ta);
        btn.textContent='âœ“ Copied!';btn.classList.add('copied');
        setTimeout(()=>{btn.textContent=id==='lde-text'?'Copy LDE':'Copy Steps';
                        btn.classList.remove('copied');},2000);
    });
}

// â”€â”€ [28] Generate Zemax report from live solver results â”€â”€â”€â”€â”€â”€â”€
function generateZemaxReport(s){
    const D1=s.D1, R1=parseFloat(document.getElementById('m1_roc').value);
    const K1=parseFloat(document.getElementById('m1_k').value);
    const R2=parseFloat(document.getElementById('m2_roc').value);
    const K2=parseFloat(document.getElementById('m2_k').value);
    const d1=parseFloat(document.getElementById('d1').value);
    const d_m3=parseFloat(document.getElementById('m3_back').value);
    const bfl=s.target_bfl;
    const Rt=s.Rt, Rs=s.Rs;
    const m2d=s.fp.m2_dia, m3sx=s.fp.m3_semi_x, m3sy=s.fp.m3_semi_y;
    const sf=s.starting_f, ff=s.final_f;
    const EFL=(ff*D1/1000).toFixed(3);

    // Thickness calculations
    const t_m1_to_m2=-d1;           // beam goes -Z to M2
    const t_m2_to_m3=d_m3+d1;      // beam returns +Z through M1 hole to M3
    const t_cb_to_img=-bfl;         // in folded local frame, -Y

    // â”€â”€ System info chips â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.getElementById('modal-sysinfo').innerHTML=`
        <div class="sysinfo-chip">Dâ‚ = <span>${D1} mm</span></div>
        <div class="sysinfo-chip">Native <span>f/${sf.toFixed(2)}</span></div>
        <div class="sysinfo-chip">Effective <span>f/${ff.toFixed(2)}</span></div>
        <div class="sysinfo-chip">EFL = <span>${EFL} m</span></div>
        <div class="sysinfo-chip">BFL = <span>${bfl} mm</span></div>
        <div class="sysinfo-chip">M2 âŒ€ = <span>${m2d.toFixed(1)} mm</span></div>
        <div class="sysinfo-chip">M3 = <span>${(2*m3sx).toFixed(2)}Ã—${(2*m3sy).toFixed(2)} mm</span></div>`;

    // â”€â”€ LDE table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const w=[5,14,11,12,10,10,9];  // column widths
    const head=['Surf','Type','Radius','Thickness','Material','Semi-Dia','Conic'];
    const sep='â”€'.repeat(w.reduce((a,b)=>a+b,0)+w.length*2+2);
    const row=(cells,cls='')=>cells.map((c,i)=>String(c).padStart(i===1?-w[i]:w[i]).padEnd(i===1?w[i]:w[i])).join('  ');

    // Build plain text (HTML spans added below)
    const lde_rows=[
        ['OBJ', 'Standard',    'Infinity',           'Infinity',  '',       '',                '',       'Object'],
        ['1',   'Standard',    R1.toFixed(3),        t_m1_to_m2,  'MIRROR', (D1/2).toFixed(1), K1,       'M1 parabola â€” conic '+K1],
        ['2',   'Standard',    R2.toFixed(3),        t_m2_to_m3,  'MIRROR', (m2d/2).toFixed(2),'K2',     'M2 hyperbola â€” conic '+K2],
        ['3',   'Coord Break', 'â€”',                  '0',         '',       'â€”',               'â€”',      'Tilt X = âˆ’45Â°'],
        ['4',   'Toroidal',    Rt.toFixed(4),        '0',         'MIRROR', m3sy.toFixed(3),   '0',      'M3 â€” Rt (meridional); Par 1 = Rs'],
        ['5',   'Coord Break', 'â€”',                  '0',         '',       'â€”',               'â€”',      'Pickup CB surf 3, scale +1'],
        ['6',   'Standard',    'Infinity',           t_cb_to_img, '',       '',                '',       'Propagate to focus (local âˆ’Z)'],
        ['IMA', 'Standard',    'Infinity',           'â€”',         '',       '',                '',       'Focal plane'],
    ];

    // Column widths adjusted for readability
    function pad(s,n,right=false){s=String(s);return right?s.padEnd(n):s.padStart(n);}
    function fmtRow(r){
        return [pad(r[0],4),pad(r[1],14,true),pad(r[2],12),pad(r[3],12),
                pad(r[4],8,true),pad(r[5],9),pad(r[6],9)].join(' ');
    }
    const hdr=fmtRow(['Surf','Type','Radius','Thickness','Matl','Semi-Dia','Conic']);
    const sp2='â”€'.repeat(hdr.length);
    let ldeHtml=`<span class="lde-head">${hdr}\n${sp2}\n</span>`;

    lde_rows.forEach((r,i)=>{
        const line=fmtRow(r)+'  ;  '+r[7];
        let cls='';
        if(i===0||i===6||i===7) cls='lde-img';
        else if(i===1||i===2) cls='lde-mirror';
        else if(i===3||i===5) cls='lde-cb';
        else if(i===4) cls='lde-toroid';
        ldeHtml+=`<span class="${cls}">${line}\n</span>`;
    });

    ldeHtml+=`\n<span class="lde-head">â”€â”€â”€ Extra Data Editor (Surface 4 â€” Toroidal) â”€â”€â”€</span>\n`;
    ldeHtml+=`<span class="lde-toroid">  Par 1  (Radius of Rotation = Rs)  ${Rs.toFixed(4)} mm\n`;
    ldeHtml+=`  Par 2  (Extra Conic â€” sagittal)    0\n`;
    ldeHtml+=`\n</span>`;
    ldeHtml+=`<span class="lde-head">â”€â”€â”€ Aperture Data â”€â”€â”€</span>\n`;
    ldeHtml+=`<span class="lde-mirror">  Surf 2 (M2) : Circular Aperture,  max radius = ${(m2d/2).toFixed(2)} mm\n`;
    ldeHtml+=`</span><span class="lde-toroid">  Surf 4 (M3) : Elliptical Aperture, X half = ${m3sx.toFixed(3)} mm (sag)\n`;
    ldeHtml+=`                               Y half = ${m3sy.toFixed(3)} mm (mer)\n`;
    ldeHtml+=`</span>`;
    ldeHtml+=`<span class="lde-head">â”€â”€â”€ System Settings â”€â”€â”€</span>\n`;
    ldeHtml+=`<span class="lde-img">  Entrance Pupil Diameter : ${D1} mm\n`;
    ldeHtml+=`  System Aperture Type    : Entrance Pupil Diameter\n`;
    ldeHtml+=`  Reference Wavelength    : 0.55 Î¼m (default; add F, e, C for achromat)\n`;
    ldeHtml+=`  Field Type              : Angle (degrees)  â†’  start with 0,0 (on-axis)\n`;
    ldeHtml+=`</span>`;

    document.getElementById('lde-text').innerHTML=ldeHtml;

    // â”€â”€ Step-by-step guide â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const steps=[
        {
            title:'System aperture and units',
            body:`Open <em>System Explorer â†’ Aperture</em>. Set:`,
            params:[
                ['Aperture Type','Entrance Pupil Diameter'],
                ['Aperture Value',D1+' mm'],
                ['Lens Units','Millimetres'],
                ['Temperature','20 Â°C  (affects substrate thickness if used)'],
            ]
        },
        {
            title:'Enter M1 â€” parabolic primary mirror',
            body:`In the LDE, Surface 1 (after OBJ): set type <strong>Standard</strong>, material <strong>MIRROR</strong>.`,
            params:[
                ['Radius',R1.toFixed(3)+' mm'],
                ['Thickness',t_m1_to_m2+' mm  (negative: beam travels âˆ’Z toward M2)'],
                ['Conic',K1],
                ['Semi-Diameter',(D1/2)+' mm'],
            ]
        },
        {
            title:'Enter M2 â€” hyperbolic secondary mirror',
            body:`Surface 2: type <strong>Standard</strong>, material <strong>MIRROR</strong>.`,
            params:[
                ['Radius',R2.toFixed(3)+' mm'],
                ['Thickness',t_m2_to_m3+' mm  (beam returns +Z through M1 hole to M3)'],
                ['Conic',K2],
                ['Semi-Diameter',(m2d/2).toFixed(2)+' mm  (footprint radius)'],
                ['Aperture Type','Circular  â€” max radius = '+(m2d/2).toFixed(2)+' mm'],
            ]
        },
        {
            title:'Insert M3 fold via Add Fold Mirror tool',
            body:`Right-click Surface 2 in the LDE â†’ <strong>Insert Surface After</strong>. Add three surfaces (CB + mirror + CB). Alternatively use <em>Lens Menu â†’ Add Fold Mirror</em> which auto-inserts the CB sandwich. Then:`,
            params:[
                ['CB1 Tilt About X','âˆ’45Â°'],
                ['CB1 Thickness','0  (vertex at current position)'],
                ['Mirror surface','type â†’ Toroidal  (next step)'],
                ['CB2 Tilt About X','Pickup from CB1, scale = +1'],
                ['CB2 Thickness','0'],
            ],
            warn:'Both Coordinate Breaks use scale = +1. Using âˆ’1 causes a tilted image plane.'
        },
        {
            title:'Configure M3 as a Toroidal mirror',
            body:`Click the type cell of the mirror surface â†’ select <strong>Toroidal</strong>. Set:`,
            params:[
                ['Radius  (meridional, Rt)',Rt.toFixed(4)+' mm'],
                ['Conic (meridional)','0  (spherical base curve)'],
                ['Material','MIRROR'],
                ['Semi-Diameter Y  (mer)',m3sy.toFixed(3)+' mm  (footprint semi-axis)'],
                ['Semi-Diameter X  (sag)','set via Elliptical Aperture below'],
            ]
        },
        {
            title:'Enter Rs in Extra Data Editor',
            body:`With surface 4 selected, open <em>Editors â†’ Extra Data Editor</em>:`,
            params:[
                ['Par 1  (Radius of Rotation = Rs)',Rs.toFixed(4)+' mm'],
                ['Par 2  (sagittal conic)','0'],
            ],
            warn:'Par 1 sign must match the meridional radius sign. Both should be negative for this concave toroid (Rt/Rs = '+(Rt/Rs).toFixed(3)+').'
        },
        {
            title:'Set apertures and propagate to focal plane',
            body:`On Surface 4 (M3) â†’ <em>Surface Properties â†’ Aperture</em>:`,
            params:[
                ['Aperture Type','Elliptical Aperture'],
                ['X Half-Width (sagittal)',m3sx.toFixed(3)+' mm'],
                ['Y Half-Width (meridional)',m3sy.toFixed(3)+' mm'],
            ]
        },
        {
            title:'Set image plane and verify',
            body:`Surface after CB2: set thickness = <strong>${t_cb_to_img} mm</strong> (negative, in folded local frame). Then run:`,
            params:[
                ['3D Layout','Confirm 90Â° fold and focus at y = âˆ’'+bfl+' mm (global)'],
                ['Spot Diagram','Expected RMS â‰ˆ '+s.stE.rms.toFixed(1)+' Î¼m  (effective f/'+ff.toFixed(2)+')'],
                ['Ray Fan','Tangential and sagittal fans should show separate astigmatic foci'],
                ['Prescription Report','Verify Par 1 = '+Rs.toFixed(4)+' on Toroidal surface'],
            ]
        },
    ];

    let stepsHtml='';
    steps.forEach((st,i)=>{
        stepsHtml+=`<div class="step">
            <div><span class="step-num">${i+1}</span><span class="step-title">${st.title}</span></div>
            <div class="step-body">
                <p style="margin:4px 0 6px;">${st.body}</p>
                <div class="param-box">`;
        st.params.forEach(([k,v])=>{
            stepsHtml+=`<div><span class="param-key">${k.padEnd(38,' ')}</span><span class="param-val">${v}</span></div>`;
        });
        stepsHtml+='</div>';
        if(st.warn) stepsHtml+=`<div class="warn-box">âš  ${st.warn}</div>`;
        stepsHtml+='</div></div>';
    });
    document.getElementById('steps-text').innerHTML=stepsHtml;

    // â”€â”€ Pitfalls tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const pitfalls=[
        {
            icon:'âš¡',title:'Coordinate Break scale factor',
            body:`CB2 must use a <strong>Pickup Solve</strong> on "Tilt About X" from CB1 with scale = <strong>+1</strong>, not âˆ’1. A scale of âˆ’1 will fold the beam in the wrong direction and produce a tilted, decentred focal plane. The two CB tilts are <em>additive</em> (each 45Â° â†’ 90Â° total) in the local coordinate frame.`
        },
        {
            icon:'âš¡',title:'Radius of Rotation sign (Par 1)',
            body:`Par 1 (R<sub>s</sub> = ${Rs.toFixed(4)} mm) must have the <strong>same sign as R<sub>t</sub></strong> (${Rt.toFixed(4)} mm) for a concave toroid. A positive R<sub>s</sub> models a saddle surface, not a focusing toroid. The ratio R<sub>t</sub>/R<sub>s</sub> = ${(Rt/Rs).toFixed(4)} â‰ˆ 2.0, consistent with the cosÂ²(45Â°) = 0.5 sagittal/tangential power ratio.`
        },
        {
            icon:'âš¡',title:'Thickness sign after fold',
            body:`After CB2, the local Z-axis points in the global âˆ’Y direction. The thickness to the image plane must therefore be <strong>negative</strong>: ${t_cb_to_img} mm. A positive value will propagate the beam back toward M3 rather than toward the detector.`
        },
        {
            icon:'âš¡',title:'M3 aperture in local frame',
            body:`The Elliptical Aperture on the Toroidal surface is defined in the <em>local (tilted) frame</em>. Enter the footprint semi-axes directly: X (sagittal) = ${m3sx.toFixed(3)} mm, Y (meridional) = ${m3sy.toFixed(3)} mm. Do not apply any cos(45Â°) projection factor â€” OpticStudio handles the tilt internally.`
        },
        {
            icon:'âš¡',title:'Oversized M2 during initial optimisation',
            body:`During optimisation of conic constants, temporarily set M2 semi-diameter larger than the footprint (e.g. ${(D1/2).toFixed(0)} mm) to avoid vignetting edge rays. Restore to the footprint value (${(m2d/2).toFixed(2)} mm) for the final performance evaluation.`
        },
        {
            icon:'ğŸ’¡',title:'Merit function for toroid optimisation',
            body:`To optimise R<sub>t</sub> and R<sub>s</sub> in OpticStudio: make the Toroidal surface Radius and Par 1 variable. Add two REAY operands at Â±full aperture (tangential marginal rays) targeting y = ${-bfl} mm, and one REAX operand (sagittal marginal ray) also targeting y = ${-bfl} mm. This mirrors the 2Ã—2 Newton solve used in this tool.`
        },
    ];

    let pitHtml='<div class="steps-block">';
    pitfalls.forEach(p=>{
        pitHtml+=`<div class="step">
            <div><span class="step-num">${p.icon}</span><span class="step-title">${p.title}</span></div>
            <div class="step-body"><p style="margin:4px 0;">${p.body}</p></div>
        </div>`;
    });
    pitHtml+='</div>';
    document.getElementById('pitfalls-text').innerHTML=pitHtml;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OPTICAL ENGINE  (unchanged from v3.4)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class Vec3{
    constructor(x,y,z){this.x=x;this.y=y;this.z=z;}
    static zero(){return new Vec3(0,0,0);}
    add(v){return new Vec3(this.x+v.x,this.y+v.y,this.z+v.z);}
    sub(v){return new Vec3(this.x-v.x,this.y-v.y,this.z-v.z);}
    mul(s){return new Vec3(this.x*s,this.y*s,this.z*s);}
    dot(v){return this.x*v.x+this.y*v.y+this.z*v.z;}
    mag(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z);}
    normalize(){const m=this.mag();return m===0?Vec3.zero():this.mul(1/m);}
}
class Ray{constructor(o,d){this.p=o;this.k=d.normalize();}
    propagate(t){return this.p.add(this.k.mul(t));}}

class ConicSurface{
    constructor(z0,R,K,ap){this.z0=z0;this.R=R;this.K=K;this.ap=ap;this.c=R!==0?1/R:0;}
    intersect(ray){
        const p=ray.p.sub(new Vec3(0,0,this.z0)),k=ray.k,F=(1+this.K)*this.c;
        const A=this.c*(k.x*k.x+k.y*k.y)+F*k.z*k.z;
        const B=2*this.c*(p.x*k.x+p.y*k.y)+2*F*p.z*k.z-2*k.z;
        const C=this.c*(p.x*p.x+p.y*p.y)+F*p.z*p.z-2*p.z;
        let t;
        if(Math.abs(A)<1e-9){t=-C/B;}
        else{const d=B*B-4*A*C;if(d<0)return null;
             const t1=(-B-Math.sqrt(d))/(2*A),t2=(-B+Math.sqrt(d))/(2*A);t=t1>1e-5?t1:t2;}
        const hit=ray.propagate(t),hl=hit.sub(new Vec3(0,0,this.z0));
        if(hl.x*hl.x+hl.y*hl.y>(this.ap/2)*(this.ap/2))return null;
        const nm=new Vec3(-this.c*hl.x,-this.c*hl.y,1-(this.K+1)*this.c*hl.z).normalize();
        const dot=ray.k.dot(nm);
        return{point:hit,normal:nm,out_dir:ray.k.sub(nm.mul(2*dot)),dist:0};
    }
}

class TiltedToroid{
    constructor(z0,Rt,Rs,ang){
        this.z0=z0;this.Rt=Rt;this.Rs=Rs;
        this.tilt=ang*Math.PI/180;
        this.cosT=Math.cos(this.tilt);this.sinT=Math.sin(this.tilt);
    }
    toLocal(p){const dz=p.z-this.z0;
        return new Vec3(p.x,p.y*this.cosT-dz*this.sinT,p.y*this.sinT+dz*this.cosT);}
    toGlobalVec(v){
        return new Vec3(v.x,v.y*this.cosT+v.z*this.sinT,-v.y*this.sinT+v.z*this.cosT);}
    static sag(x,y,Cx,Cy){
        const dX=1-Cx*Cx*x*x,dY=1-Cy*Cy*y*y;
        if(dX<0||dY<0)return null;
        return(Cx*x*x)/(1+Math.sqrt(dX))+(Cy*y*y)/(1+Math.sqrt(dY));}
    intersect(ray){
        const np=new Vec3(0,this.sinT,this.cosT),dn=ray.k.dot(np);
        if(Math.abs(dn)<1e-6)return null;
        let tc=new Vec3(0,0,this.z0).sub(ray.p).dot(np)/dn;
        const Cx=1/this.Rs,Cy=1/this.Rt;
        for(let i=0;i<20;i++){
            const loc=this.toLocal(ray.propagate(tc));
            const zs=TiltedToroid.sag(loc.x,loc.y,Cx,Cy);if(zs===null)return null;
            const kl=this.toLocal(ray.p.add(ray.k)).sub(this.toLocal(ray.p));
            if(Math.abs(kl.z)<1e-12)break;tc-=(loc.z-zs)/kl.z;}
        const hit=ray.propagate(tc),loc=this.toLocal(hit);
        const Cx2=1/this.Rs,Cy2=1/this.Rt;
        const dX=1-Cx2*Cx2*loc.x*loc.x,dY=1-Cy2*Cy2*loc.y*loc.y;
        if(dX<=0||dY<=0)return null;
        const nl=new Vec3(-Cx2*loc.x/Math.sqrt(dX),-Cy2*loc.y/Math.sqrt(dY),1).normalize();
        const ng=this.toGlobalVec(nl),dot=ray.k.dot(ng);
        return{point:hit,normal:ng,out_dir:ray.k.sub(ng.mul(2*dot)),dist:tc};
    }
}

function computeFoV(fn,D,det){
    const EFL=fn*D,PS=206265/EFL,fa=det*PS;
    return{EFL,plateScale:PS,fov_as:fa,fov_amin:fa/60,fov_deg:fa/3600};}

function buildPupil(N){
    const pts=[{px:0,py:0,rho:0}];
    for(let r=1;r<=N;r++){const n=6*r,rho=r/N;
        for(let i=0;i<n;i++){const a=2*Math.PI*i/n;
            pts.push({px:rho*Math.cos(a),py:rho*Math.sin(a),rho});}}
    return pts;}

function computeFootprints(m1,m2_big,m3surf,D1){
    const pupil=buildPupil(20);
    const m2r=[],m3lx=[],m3ly=[];
    for(const{px,py}of pupil){
        const h1=m1.intersect(new Ray(new Vec3(px*D1/2,py*D1/2,-1000),new Vec3(0,0,1)));
        if(!h1)continue;
        const h2=m2_big.intersect(new Ray(h1.point,h1.out_dir));if(!h2)continue;
        m2r.push(Math.sqrt(h2.point.x*h2.point.x+h2.point.y*h2.point.y));
        const h3=m3surf.intersect(new Ray(h2.point,h2.out_dir));if(!h3)continue;
        const loc=m3surf.toLocal(h3.point);m3lx.push(loc.x);m3ly.push(loc.y);
    }
    const m2_dia=2*Math.max(...m2r);
    const m3_semi_x=(Math.max(...m3lx)-Math.min(...m3lx))/2;
    const m3_semi_y=(Math.max(...m3ly)-Math.min(...m3ly))/2;
    const m3_cx=(Math.max(...m3lx)+Math.min(...m3lx))/2;
    const m3_cy=(Math.max(...m3ly)+Math.min(...m3ly))/2;
    return{m2_dia,m3_semi_x,m3_semi_y,m3_cx,m3_cy,m2_rmax:m2_dia/2};
}

function solveSystem(){
    const g=id=>parseFloat(document.getElementById(id).value);
    const D1=g('m1_dia'),R1=g('m1_roc'),K1=g('m1_k');
    const R2=g('m2_roc'),K2=g('m2_k'),d1=g('d1');
    const d_m3=g('m3_back'),bfl=g('target_bfl');
    const det=g('det_diag'),lmm=g('lambda_nm')*1e-6;
    const z_m1=0,z_m2=-d1,z_m3=d_m3,TY=-bfl;
    const m1=new ConicSurface(z_m1,R1,K1,D1);
    const m2_big=new ConicSurface(z_m2,R2,K2,D1);
    const h1m=m1.intersect(new Ray(new Vec3(0,D1/2,-1000),new Vec3(0,0,1)));
    const h2m=m2_big.intersect(new Ray(h1m.point,h1m.out_dir));
    let sf=0,sod=1000,znf=0;
    if(h2m){
        const tf=-h2m.point.y/h2m.out_dir.y;
        sf=(D1/2)/Math.abs(h2m.out_dir.y/h2m.out_dir.z)/D1;
        znf=h2m.point.z+tf*h2m.out_dir.z;sod=znf-z_m3;
    }
    const P=1/bfl-1/sod,Rb=2/P,c45=Math.cos(Math.PI/4);
    let Rt=Rb*c45,Rs=Rb/c45;
    function err(tRt,tRs){
        const s=new TiltedToroid(z_m3,tRt,tRs,45);
        const h1t=m1.intersect(new Ray(new Vec3(0, D1/2,-1000),new Vec3(0,0,1)));
        const h2t=m2_big.intersect(new Ray(h1t.point,h1t.out_dir));
        const h3t=s.intersect(new Ray(h2t.point,h2t.out_dir));
        const h1b=m1.intersect(new Ray(new Vec3(0,-D1/2,-1000),new Vec3(0,0,1)));
        const h2b=m2_big.intersect(new Ray(h1b.point,h1b.out_dir));
        const h3b=s.intersect(new Ray(h2b.point,h2b.out_dir));
        if(!h3t||!h3b)return null;
        const mt=h3t.out_dir.z/h3t.out_dir.y,mb=h3b.out_dir.z/h3b.out_dir.y;
        if(Math.abs(mt-mb)<1e-12)return null;
        const Yc=((h3b.point.z-h3b.point.y*mb)-(h3t.point.z-h3t.point.y*mt))/(mt-mb);
        const h1s=m1.intersect(new Ray(new Vec3(D1/2,0,-1000),new Vec3(0,0,1)));
        const h2s=m2_big.intersect(new Ray(h1s.point,h1s.out_dir));
        const h3s=s.intersect(new Ray(h2s.point,h2s.out_dir));
        if(!h3s)return null;
        const ts=-h3s.point.x/h3s.out_dir.x;
        const Ys=h3s.point.y+ts*h3s.out_dir.y;
        const tu=Math.abs(h3t.out_dir.z)/Math.abs(h3t.out_dir.y);
        return{eM:Yc-TY,eS:Ys-TY,tan_u:tu};
    }
    const st=0.5,dp=0.85;
    for(let i=0;i<80;i++){
        const r0=err(Rt,Rs);if(!r0)break;
        const rT=err(Rt+st,Rs),rS=err(Rt,Rs+st);if(!rT||!rS)break;
        const J00=(rT.eM-r0.eM)/st,J01=(rS.eM-r0.eM)/st;
        const J10=(rT.eS-r0.eS)/st,J11=(rS.eS-r0.eS)/st;
        const det2=J00*J11-J01*J10;if(Math.abs(det2)<1e-20)break;
        Rt-=dp*(J11*r0.eM-J01*r0.eS)/det2;
        Rs-=dp*(-J10*r0.eM+J00*r0.eS)/det2;
        if(Math.abs(r0.eM)<1e-7&&Math.abs(r0.eS)<1e-7)break;
    }
    const fin=err(Rt,Rs);
    const ff=(fin&&fin.tan_u>0)?((D1/2)/fin.tan_u)/D1:0;
    const m3surf=new TiltedToroid(z_m3,Rt,Rs,45);
    const fp=computeFootprints(m1,m2_big,m3surf,D1);
    const m2=new ConicSurface(z_m2,R2,K2,fp.m2_dia);
    const fvN=computeFoV(sf,D1,det),fvE=computeFoV(ff,D1,det);
    const pupil=buildPupil(10);
    const sN=[],sE=[];
    for(const{px,py,rho}of pupil){
        const h1=m1.intersect(new Ray(new Vec3(px*D1/2,py*D1/2,-500),new Vec3(0,0,1)));
        if(!h1)continue;
        const h2=m2_big.intersect(new Ray(h1.point,h1.out_dir));if(!h2)continue;
        const tn=(znf-h2.point.z)/h2.out_dir.z;
        const fn2=h2.point.add(h2.out_dir.mul(tn));
        sN.push({x:fn2.x*1000,y:fn2.y*1000,rho});
        const h3=m3surf.intersect(new Ray(h2.point,h2.out_dir));if(!h3)continue;
        const te=(-bfl-h3.point.y)/h3.out_dir.y;
        const fe=h3.point.add(h3.out_dir.mul(te));
        sE.push({x:fe.x*1000,z:fe.z*1000,rho});
    }
    const cxN=sN.reduce((s,p)=>s+p.x,0)/sN.length,cyN=sN.reduce((s,p)=>s+p.y,0)/sN.length;
    const cxE=sE.reduce((s,p)=>s+p.x,0)/sE.length,czE=sE.reduce((s,p)=>s+p.z,0)/sE.length;
    sN.forEach(p=>{p.x-=cxN;p.y-=cyN;});sE.forEach(p=>{p.x-=cxE;p.z-=czE;});
    const rms=(pts,a,b)=>{const r2=pts.map(p=>p[a]*p[a]+p[b]*p[b]);
        return{rms:Math.sqrt(r2.reduce((s,v)=>s+v,0)/r2.length),rmax:Math.sqrt(Math.max(...r2))};};
    const stN=rms(sN,'x','y'),stE=rms(sE,'x','z');
    const airN=1.22*lmm*sf*1e6,airE=1.22*lmm*ff*1e6;
    return{Rt,Rs,m1,m2,m2_big,z_m3,target_bfl:bfl,D1,det,lmm,
           starting_f:sf,final_f:ff,final:fin,
           fov_native:fvN,fov_eff:fvE,z_native_focus:znf,
           spotsNative:sN,spotsEff:sE,stN,stE,airN,airE,
           fp,m3surf,m3dia:2*Math.max(fp.m3_semi_x,fp.m3_semi_y)};
}

function runOptimization(){
    const st2=document.getElementById('status-msg');
    st2.textContent='Optimisingâ€¦';st2.style.color='var(--accent)';
    if(isMobile()){
        const sb=document.getElementById('sidebar'),btn=document.getElementById('sidebarToggle');
        if(sb.classList.contains('open')){sb.classList.remove('open');btn.classList.remove('open');
            btn.setAttribute('aria-expanded','false');}
    }
    setTimeout(()=>{
        const s=solveSystem();
        _lastSol=s;  // [28] store for Zemax export
        document.getElementById('zemaxBtn').disabled=false;
        buildResults(s);
        st2.textContent='Trace Complete';st2.style.color='#666';
        plotSystem(s);plotSpots(s);
    },50);
}

function buildResults(s){
    const p=document.getElementById('results');
    const rd=Math.abs(s.Rt-s.Rs);
    const eM_ok=s.final&&Math.abs(s.final.eM)<0.001,eS_ok=s.final&&Math.abs(s.final.eS)<0.001;
    const fv=f=>`${f.fov_amin.toFixed(2)}â€² (${f.fov_deg.toFixed(3)}Â°)`;
    const ps=f=>`${f.plateScale.toFixed(2)} â€³/mm`,el=f=>`${(f.EFL/1000).toFixed(3)} m`;
    const m3s=(2*s.fp.m3_semi_x).toFixed(2),m3m=(2*s.fp.m3_semi_y).toFixed(2);
    const m3e=(2*Math.max(s.fp.m3_semi_x,s.fp.m3_semi_y)).toFixed(2);
    p.innerHTML=`
        <div class="sub-header">M1 + M2 (native)</div>
        <div class="metric-row"><span class="metric-label">F#</span><span class="metric-val val-info">f/${s.starting_f.toFixed(2)}</span></div>
        <div class="metric-row"><span class="metric-label">EFL</span><span class="metric-val">${el(s.fov_native)}</span></div>
        <div class="metric-row"><span class="metric-label">Plate scale</span><span class="metric-val">${ps(s.fov_native)}</span></div>
        <div class="metric-row"><span class="metric-label">FoV (${s.det} mm)</span><span class="metric-val val-warn">${fv(s.fov_native)}</span></div>
        <div class="metric-row"><span class="metric-label">Spot RMS/max</span><span class="metric-val">${s.stN.rms.toFixed(2)} / ${s.stN.rmax.toFixed(2)} Î¼m</span></div>
        <div class="sub-header">M1 + M2 + M3 (effective)</div>
        <div class="metric-row"><span class="metric-label">F#</span><span class="metric-val val-info">f/${s.final_f.toFixed(2)}</span></div>
        <div class="metric-row"><span class="metric-label">EFL</span><span class="metric-val">${el(s.fov_eff)}</span></div>
        <div class="metric-row"><span class="metric-label">Plate scale</span><span class="metric-val">${ps(s.fov_eff)}</span></div>
        <div class="metric-row"><span class="metric-label">FoV (${s.det} mm)</span><span class="metric-val val-warn">${fv(s.fov_eff)}</span></div>
        <div class="metric-row"><span class="metric-label">Spot RMS/max</span>
            <span class="metric-val ${s.stE.rms>s.airE?'val-bad':'val-good'}">${s.stE.rms.toFixed(2)} / ${s.stE.rmax.toFixed(2)} Î¼m</span></div>
        <div class="sub-header">Mirror Footprints</div>
        <div class="metric-row"><span class="metric-label">M2 âŒ€</span><span class="metric-val val-info">${s.fp.m2_dia.toFixed(2)} mm</span></div>
        <div class="metric-row"><span class="metric-label">M3 sag Ã— mer</span><span class="metric-val val-info">${m3s} Ã— ${m3m} mm</span></div>
        <div class="metric-row"><span class="metric-label">M3 encircling âŒ€</span><span class="metric-val">${m3e} mm</span></div>
        <div class="metric-row"><span class="metric-label">M3 axis ratio b/a</span><span class="metric-val">${(s.fp.m3_semi_y/s.fp.m3_semi_x).toFixed(3)}</span></div>
        <div class="sub-header">M3 Toroid</div>
        <div class="metric-row"><span class="metric-label">Rt (tang.)</span><span class="metric-val">${s.Rt.toFixed(2)} mm</span></div>
        <div class="metric-row"><span class="metric-label">Rs (sag.)</span><span class="metric-val">${s.Rs.toFixed(2)} mm</span></div>
        <div class="metric-row"><span class="metric-label">Rt / Rs</span><span class="metric-val">${(s.Rt/s.Rs).toFixed(3)}</span></div>
        <div class="metric-row"><span class="metric-label">Î”R</span>
            <span class="metric-val ${Math.abs(s.Rt-s.Rs)>200?'val-bad':'val-good'}">${rd.toFixed(2)} mm</span></div>
        <div class="sub-header">Solver residuals</div>
        <div class="metric-row"><span class="metric-label">Meridional eM</span>
            <span class="metric-val ${eM_ok?'val-good':'val-bad'}">${s.final?s.final.eM.toExponential(2):'n/a'} mm</span></div>
        <div class="metric-row"><span class="metric-label">Sagittal eS</span>
            <span class="metric-val ${eS_ok?'val-good':'val-bad'}">${s.final?s.final.eS.toExponential(2):'n/a'} mm</span></div>`;
}

function plotSystem(sol){
    const traces=[],blue='#00bcd4',orange='#ff9800',fp_col='rgba(255,180,0,0.55)';
    const mobile=isMobile();
    function drawConic(surf,dia,color){
        const y=[],z=[];
        for(let i=-40;i<=40;i++){
            const h=(dia/2)*(i/40),r2=h*h;y.push(h);
            z.push(surf.z0+(surf.c*r2)/(1+Math.sqrt(Math.max(0,1-(1+surf.K)*surf.c*surf.c*r2))));}
        return{x:z,y,mode:'lines',line:{color,width:3},hoverinfo:'skip'};}
    traces.push(drawConic(sol.m1,sol.D1,blue));
    traces.push(drawConic(sol.m2,sol.fp.m2_dia,blue));
    const m2r=sol.fp.m2_dia/2,th2=Array.from({length:61},(_,i)=>-Math.PI+2*Math.PI*i/60);
    traces.push({x:th2.map(t=>sol.m2.z0+(sol.m2.c*Math.pow(m2r*Math.sin(t),2))/(1+Math.sqrt(Math.max(0,1-(1+sol.m2.K)*sol.m2.c*sol.m2.c*Math.pow(m2r*Math.sin(t),2))))),
        y:th2.map(t=>m2r*Math.sin(t)),mode:'lines',
        line:{color:fp_col,width:1.5,dash:'dot'},showlegend:false,hoverinfo:'skip'});
    const m3_mer_ext=sol.fp.m3_semi_y,Cy=1/sol.Rt,cT=Math.cos(Math.PI/4),sT=Math.sin(Math.PI/4);
    const m3y=[],m3z=[];
    for(let i=0;i<81;i++){const yl=m3_mer_ext*((i/80)*2-1),dY=1-Cy*Cy*yl*yl;
        const zl=dY>0?(Cy*yl*yl)/(1+Math.sqrt(dY)):0;
        m3y.push(yl*cT+zl*sT);m3z.push(sol.z_m3-yl*sT+zl*cT);}
    traces.push({x:m3z,y:m3y,mode:'lines',line:{color:orange,width:3},name:'M3',hoverinfo:'skip'});
    const a=sol.fp.m3_semi_x,b=sol.fp.m3_semi_y;
    const thE=Array.from({length:61},(_,i)=>2*Math.PI*i/60);
    const ell_gy=[],ell_gz=[];
    for(let i=0;i<thE.length;i++){
        ell_gy.push(b*Math.sin(thE[i])*cT);
        ell_gz.push(sol.z_m3+b*Math.sin(thE[i])*(-sT));}
    traces.push({x:ell_gz,y:ell_gy,mode:'lines',
        line:{color:fp_col,width:1.5,dash:'dot'},showlegend:false,hoverinfo:'skip'});
    const dn=parseInt(document.getElementById('ray_density').value);
    const rx2=parseFloat(document.getElementById('ray_len').value);
    const xr=[],yr=[];
    for(let i=0;i<dn;i++){
        const h=(sol.D1/2)*((2*i/(dn-1))-1);
        const h1=sol.m1.intersect(new Ray(new Vec3(0,h,-500),new Vec3(0,0,1)));if(!h1)continue;
        const h2=sol.m2_big.intersect(new Ray(h1.point,h1.out_dir));if(!h2)continue;
        const h3=sol.m3surf.intersect(new Ray(h2.point,h2.out_dir));if(!h3)continue;
        const tf=(-sol.target_bfl-h3.point.y)/h3.out_dir.y;
        const pe=h3.point.add(h3.out_dir.mul(tf+rx2));
        xr.push(-200,h1.point.z,h2.point.z,h3.point.z,pe.z,null);
        yr.push(h,h1.point.y,h2.point.y,h3.point.y,pe.y,null);}
    traces.push({x:xr,y:yr,mode:'lines',line:{color:'rgba(255,255,255,0.18)',width:1},
        showlegend:false,hoverinfo:'skip'});
    Plotly.newPlot('plotDiv',traces,{
        title:{text:'Optical Layout Â· Footprint outlines (dotted)',font:{size:mobile?11:13}},
        paper_bgcolor:'#050505',plot_bgcolor:'#050505',font:{color:'#aaa',size:mobile?9:11},
        xaxis:{title:{text:'Z (mm)',standoff:mobile?2:6},gridcolor:'#222',zerolinecolor:'#444',
               scaleanchor:'y',scaleratio:1},
        yaxis:{title:{text:'Y (mm)',standoff:mobile?2:6},gridcolor:'#222',zerolinecolor:'#444'},
        margin:mobile?{l:38,r:8,t:30,b:36}:{l:50,r:20,t:40,b:40},
        showlegend:false,dragmode:'pan'
    },{responsive:true,displayModeBar:!mobile,scrollZoom:!mobile,
       modeBarButtonsToRemove:['toImage','lasso2d','select2d']});
}

function plotSpots(sol){
    const mobile=isMobile();
    const rhoColor=rho=>`hsl(${Math.round(240*(1-rho))},90%,60%)`;
    function airyCircle(r,xa,ya){
        const th=Array.from({length:101},(_,i)=>2*Math.PI*i/100);
        return{x:th.map(t=>r*Math.cos(t)),y:th.map(t=>r*Math.sin(t)),
               mode:'lines',line:{color:'rgba(255,255,255,0.55)',dash:'dash',width:1.5},
               showlegend:false,hoverinfo:'none',xaxis:xa,yaxis:ya};}
    const nat_c=sol.spotsNative.map(p=>rhoColor(p.rho));
    const eff_c=sol.spotsEff.map(p=>rhoColor(p.rho));
    const rN=Math.max(sol.stN.rmax,sol.airN)*1.5,rE=Math.max(sol.stE.rmax,sol.airE)*1.5;
    const lnm=Math.round(sol.lmm*1e6);
    const as={xref:'paper',yref:'paper',showarrow:false,
              font:{size:mobile?8:9,color:'#aaa'},bgcolor:'rgba(0,0,0,0.55)'};
    const baseTraces=[
        {x:sol.spotsNative.map(p=>p.x),y:sol.spotsNative.map(p=>p.y),mode:'markers',
         marker:{color:nat_c,size:3,opacity:0.85},showlegend:false,hoverinfo:'none',xaxis:'x1',yaxis:'y1'},
        airyCircle(sol.airN,'x1','y1'),
        {x:sol.spotsEff.map(p=>p.x),y:sol.spotsEff.map(p=>p.z),mode:'markers',
         marker:{color:eff_c,size:3,opacity:0.85},showlegend:false,hoverinfo:'none',xaxis:'x2',yaxis:'y2'},
        airyCircle(sol.airE,'x2','y2')];
    const baseLayout={paper_bgcolor:'#0a0a0a',plot_bgcolor:'#0a0a0a',
        font:{color:'#aaa',size:mobile?8:10},showlegend:false};
    let layout;
    if(mobile){
        layout={...baseLayout,margin:{l:36,r:8,t:28,b:36},
            grid:{rows:2,columns:1,pattern:'independent',roworder:'top to bottom'},
            xaxis:{domain:[0,1],title:{text:'X (Î¼m)',standoff:2},range:[-rN,rN],
                   gridcolor:'#1e1e1e',zerolinecolor:'#333',scaleanchor:'y',scaleratio:1},
            yaxis:{title:{text:'Y (Î¼m)',standoff:2},range:[-rN,rN],gridcolor:'#1e1e1e',zerolinecolor:'#333'},
            xaxis2:{domain:[0,1],title:{text:'X sag. (Î¼m)',standoff:2},range:[-rE,rE],
                    gridcolor:'#1e1e1e',zerolinecolor:'#333',scaleanchor:'y2',scaleratio:1},
            yaxis2:{title:{text:'Z mer. (Î¼m)',standoff:2},range:[-rE,rE],
                    gridcolor:'#1e1e1e',zerolinecolor:'#333',anchor:'x2'},
            annotations:[
                {...as,x:.5,y:1.0,xanchor:'center',yanchor:'top',text:`<b>Native f/${sol.starting_f.toFixed(1)}</b>`},
                {...as,x:.02,y:.52,xanchor:'left',yanchor:'top',text:`RMS ${sol.stN.rms.toFixed(1)}Î¼m Â· Airy ${sol.airN.toFixed(1)}Î¼m`},
                {...as,x:.5,y:.50,xanchor:'center',yanchor:'top',text:`<b>Effective f/${sol.final_f.toFixed(1)}</b>`},
                {...as,x:.02,y:.02,xanchor:'left',yanchor:'bottom',text:`RMS ${sol.stE.rms.toFixed(1)}Î¼m Â· Airy ${sol.airE.toFixed(1)}Î¼m (Î»=${lnm}nm)`}
            ]};
    }else{
        layout={...baseLayout,margin:{l:48,r:16,t:34,b:40},
            grid:{rows:1,columns:2,pattern:'independent'},
            xaxis:{domain:[0,.46],title:{text:'X (Î¼m)',standoff:4},range:[-rN,rN],
                   gridcolor:'#1e1e1e',zerolinecolor:'#333',scaleanchor:'y',scaleratio:1},
            yaxis:{title:{text:'Y (Î¼m)',standoff:4},range:[-rN,rN],gridcolor:'#1e1e1e',zerolinecolor:'#333'},
            xaxis2:{domain:[.54,1],title:{text:'X sagittal (Î¼m)',standoff:4},range:[-rE,rE],
                    gridcolor:'#1e1e1e',zerolinecolor:'#333',scaleanchor:'y2',scaleratio:1},
            yaxis2:{title:{text:'Z meridional (Î¼m)',standoff:4},range:[-rE,rE],
                    gridcolor:'#1e1e1e',zerolinecolor:'#333',anchor:'x2'},
            annotations:[
                {...as,x:.23,y:1.0,xanchor:'center',yanchor:'top',
                 text:`<b>Native f/${sol.starting_f.toFixed(2)}</b> Â· EFL ${(sol.fov_native.EFL/1000).toFixed(2)} m`},
                {...as,x:.77,y:1.0,xanchor:'center',yanchor:'top',
                 text:`<b>Effective f/${sol.final_f.toFixed(2)}</b> Â· EFL ${(sol.fov_eff.EFL/1000).toFixed(2)} m`},
                {...as,x:.01,y:.01,xanchor:'left',yanchor:'bottom',
                 text:`RMS ${sol.stN.rms.toFixed(2)}Î¼m  max ${sol.stN.rmax.toFixed(2)}Î¼m<br>Airy r=${sol.airN.toFixed(2)}Î¼m (Î»=${lnm}nm)`},
                {...as,x:.54,y:.01,xanchor:'left',yanchor:'bottom',
                 text:`RMS ${sol.stE.rms.toFixed(2)}Î¼m  max ${sol.stE.rmax.toFixed(2)}Î¼m<br>Airy r=${sol.airE.toFixed(2)}Î¼m (Î»=${lnm}nm)`}
            ]};}
    Plotly.newPlot('spotDiv',baseTraces,layout,{responsive:true,displayModeBar:false,staticPlot:mobile});
}

let _rt;
window.addEventListener('resize',()=>{clearTimeout(_rt);_rt=setTimeout(()=>{
    Plotly.Plots.resize('plotDiv');Plotly.Plots.resize('spotDiv');},150);});
window.onload=runOptimization;
</script>
</body>
</html>
